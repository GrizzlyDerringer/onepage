<script src="https://code.jquery.com/jquery-2.2.4.min.js"
        integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
        crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jplayer/2.9.2/jplayer/jquery.jplayer.min.js"></script>
<script type="text/javascript">
    $(function () {
        'use strict';
        var $jplayer = $('.player').jPlayer({
                supplied: 'mp3',
                ended: onEnded
            });

        setBindings();

        function onTrackRowClick(e){
            e.preventDefault();
            var $this = $(this),
                $playbutton = $this.find('.song-control'),
                href = $playbutton.attr('href');
            if($this.hasClass('playing')){
                $jplayer.jPlayer('pause');
                $('.playlist-row').removeClass('playing');
                $playbutton.removeClass('glyphicon-pause')
                            .addClass('glyphicon-play');
                setBindings();
                $('.jp-audio').removeClass('is-playing');
            }else{
                playTrack(href);
                $('.playlist-row').removeClass('playing');
                $this.addClass('playing');
                $('.song-control')
                        .removeClass('glyphicon-pause')
                        .addClass('glyphicon-play');
                $playbutton.removeClass('glyphicon-play');
                $playbutton.addClass('glyphicon-pause');
                setBindings();
            }
        }

        function onPlayButtonClick(e) {
            e.stopPropagation();
            e.preventDefault();
            var $this = $(this),
                href = $this.attr('href');
            playTrack(href);
            $('.playlist-row').removeClass('playing')
            $this.closest('tr').addClass('playing');
            $('.song-control')
                    .removeClass('glyphicon-pause')
                    .addClass('glyphicon-play');
            $this.removeClass('glyphicon-play');
            $this.addClass('glyphicon-pause');
            setBindings();
        }

        function onPauseButtonClick(e) {
            e.stopPropagation();
            e.preventDefault();
            var $this = $(this);
            $jplayer.jPlayer('pause');
            $('.playlist-row').removeClass('playing');
            $this.removeClass('glyphicon-pause')
                 .addClass('glyphicon-play');
            setBindings();
            $('.jp-audio').removeClass('is-playing');
        }

        function onEnded() {
            var $next_tr = $('.glyphicon-pause').closest('tr').next('tr'),
                $next_playbutton = $next_tr.find('.glyphicon-play');
            $('.playlist-row').removeClass('playing');
            $next_tr.addClass('playing');
            $('.song-control')
                    .removeClass('glyphicon-pause')
                    .addClass('glyphicon-play');
            if($next_playbutton) {
                var href = $next_playbutton.attr('href');
                playTrack(href);
                $next_playbutton.removeClass('glyphicon-play');
                $next_playbutton.addClass('glyphicon-pause');
            }
            setBindings();
        }

        function setBindings () {
            $('.glyphicon-pause').off().on('click', onPauseButtonClick);
            $('.glyphicon-play').off().on('click', onPlayButtonClick);
            $('.playlist-row').off().on('click', onTrackRowClick);
            $('#collectionsToggle').off().on('click', onCollectionsToggleClick);
        }

        function playTrack(href) {
            $jplayer.jPlayer('setMedia', {
                mp3: href
            }).jPlayer('play');
            $('.jp-audio').addClass('is-playing');
            trackEvent('playbackStart', href);
        }

        function trackEvent(action, label){
            if(window.ga){
                ga('send', {
                    hitType: 'event',
                    eventCategory: 'songs',
                    eventAction: action,
                    eventLabel: label
                });
            }
        }

        function onCollectionsToggleClick(e){
            e.preventDefault();
            $('#collectionsDropdown').toggleClass('open');
        }
    });
</script>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-78278085-1', 'auto');
    ga('send', 'pageview');
</script>